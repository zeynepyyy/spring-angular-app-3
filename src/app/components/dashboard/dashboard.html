<div class="dashboard-layout" [class.dark-mode]="isDarkMode()">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="/assets/logo.png" alt="Z-Bank Logo" class="brand-logo">
    </div>

    <nav class="sidebar-nav">
      <a href="javascript:void(0)" class="nav-item" [class.active]="activeView() === 'dashboard'"
        (click)="setView('dashboard')">
        <span class="icon">ğŸ“Š</span>
        <span>Ã–zet</span>
      </a>
      <a routerLink="/analysis" class="nav-item" style="cursor: pointer;">
        <span class="icon">ğŸ“‰</span>
        <span>Harcama Analizi</span>
      </a>
      <a href="javascript:void(0)" class="nav-item" [class.active]="activeView() === 'accounts'"
        (click)="setView('accounts')">
        <span class="icon">ğŸ’³</span>
        <span>Hesaplar</span>
      </a>
      <a href="javascript:void(0)" class="nav-item" (click)="toggleTransfer()">
        <span class="icon">ğŸ’¸</span>
        <span>Transferler</span>
      </a>
      <a routerLink="/loan" class="nav-item" style="cursor: pointer;">
        <span class="icon">ğŸ’°</span>
        <span>Kredi Ã‡ek</span>
      </a>
      <a routerLink="/bills" class="nav-item" style="cursor: pointer;">
        <span class="icon">ğŸ§¾</span>
        <span>Faturalar</span>
      </a>
      <a routerLink="/exchange" class="nav-item" style="cursor: pointer;">
        <span class="icon">ğŸ“ˆ</span>
        <span>DÃ¶viz & AltÄ±n</span>
      </a>

      <a href="javascript:void(0)" class="nav-item" (click)="toggleProfileSettings()">
        <span class="icon">âš™ï¸</span>
        <span>Ayarlar</span>
      </a>
    </nav>


    <div class="currency-widget">
      <h3>Piyasalar ğŸ“ˆ</h3>
      <div class="currency-item">
        <span class="currency-name">USD/TRY</span>
        <span class="currency-rate">{{ currencyRates().usd | number:'1.2-2' }} â‚º</span>
      </div>
      <div class="currency-item">
        <span class="currency-name">EUR/TRY</span>
        <span class="currency-rate">{{ currencyRates().eur | number:'1.2-2' }} â‚º</span>
      </div>
      <div class="currency-item">
        <span class="currency-name">ALTIN (Gr)</span>
        <span class="currency-rate">{{ currencyRates().gold | number:'1.0-0' }} â‚º</span>
      </div>
    </div>


    <div class="quick-actions">
      <h3>HÄ±zlÄ± Ä°ÅŸlemler âš¡</h3>
      <div class="action-buttons">
        <button class="action-btn">ğŸ§¾ Fatura Ã–de</button>
        <button class="action-btn" routerLink="/qr">ğŸ“· QR ile Ã–de</button>
        <button class="action-btn">ğŸ’± DÃ¶viz Al/Sat</button>
      </div>
    </div>

    <div class="sidebar-footer">
      <button class="logout-btn" routerLink="/login">
        <span class="icon">ğŸšª</span>
        <span>GÃ¼venli Ã‡Ä±kÄ±ÅŸ</span>
      </button>
    </div>
  </aside>


  <main class="main-content">
    <header class="top-bar">
      <h1>HoÅŸ Geldiniz</h1>
      <div class="user-profile">
        <button class="theme-toggle-btn" (click)="toggleTheme()"
          [title]="isDarkMode() ? 'KaranlÄ±k Mod' : 'AydÄ±nlÄ±k Mod'">
          {{ isDarkMode() ?   'ğŸŒ™' :'â˜€ï¸'}}
        </button>


        <div class="notification-wrapper">
          <button class="notification-btn" (click)="toggleNotifications()">
            ğŸ””
            @if (unreadCount > 0) {
            <span class="badge">{{ unreadCount }}</span>
            }
          </button>

          @if (showNotifications()) {
          <div class="notification-dropdown">
            <h3>Bildirimler</h3>
            @for (note of notifications(); track note.id) {
            <div class="notification-item" [class.unread]="!note.isRead">
              <div class="note-text">{{ note.message }}</div>
              <div class="note-time">{{ note.createDate | date:'dd.MM.yyyy HH:mm' }}</div>
            </div>
            }
          </div>
          }
        </div>

        <div class="user-profile-clickable" (click)="toggleProfileSettings()" title="Profil AyarlarÄ±">
          <div class="avatar">U</div>
          <span class="user-name">{{ getCustomerName() }}</span>
        </div>
      </div>
    </header>


    @if (showProfileSettings()) {
    <div class="modal-overlay" (click)="toggleProfileSettings()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Profil AyarlarÄ±</h3>
          <button class="close-btn" (click)="toggleProfileSettings()">âœ–</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Ad Soyad</label>
            <input type="text" [value]="getCustomerName()" disabled>
          </div>
          <div class="form-group">
            <label>E-posta</label>
            <input type="email" value="ornek@email.com" disabled>
          </div>
          <div class="form-group">
            <label>Åifre</label>
            <input type="password" value="********" disabled>
            <button class="link-btn">Åifre DeÄŸiÅŸtir</button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="save-btn">Kaydet</button>
        </div>
      </div>
    </div>
    }

    <div class="content-scroll">

      <section class="accounts-section">
        <div class="section-header">
          <h2>HesaplarÄ±m</h2>
          <div class="header-actions">
            <button class="transfer-toggle-btn" (click)="toggleTransfer()">ğŸ’¸ Transfer Yap</button>
            <button class="add-btn" (click)="createVirtualCard()">+ Sanal Kart OluÅŸtur</button>
          </div>
        </div>

        @if (showTransfer()) {
        <div class="transfer-dropdown">
          <app-transfer></app-transfer>
        </div>
        }

        @if (isLoading()) {
        <div class="loader-container">
          <div class="spinner"></div>
          <p>Verileriniz gÃ¼venle yÃ¼kleniyor...</p>
        </div>
        } @else {
        <div class="cards-grid">
          @for (acc of accounts(); track acc.id) {

          <div class="credit-card" [ngClass]="getAccountClass(acc.accountType)"
            [class.selected-card]="currentAccountId === acc.id" (click)="selectAccount(acc.id)"
            style="cursor: pointer;">
            <div class="card-chip">
              <div class="chip-part"></div>
            </div>
            <div class="card-logo">Z-Bank</div>

            <div class="card-balance">
              <span class="label">Bakiye</span>
              <span class="amount">{{ acc.balance | currency:'TRY':'symbol':'1.2-2' }}</span>
            </div>

            <div class="card-details">
              <div class="card-holder">
                <span class="label">Hesap Sahibi</span>
                <span class="value">{{ acc.customer?.firstName }} {{ acc.customer?.lastName }}</span>
              </div>
              <div class="card-number">
                <span class="label">Hesap No</span>
                <span class="value">{{ acc.accountNumber }}</span>
              </div>
            </div>

            <div class="card-type-badge">{{ acc.accountType }}</div>


            @if (acc.accountType === 'KREDI' && acc.balance < 0) { <button class="pay-debt-btn"
              (click)="openPaymentModal(acc); $event.stopPropagation()">
              BorÃ§ Ã–de
              </button>
              }


              @if (acc.accountType?.toUpperCase() === 'HEDEF' && acc.goalAmount > 0) {
              <div class="goal-overlay">
                <div class="goal-info">
                  <span>Hedef: {{ acc.goalAmount | currency:'TRY':'symbol-narrow':'1.0-0' }}</span>
                  <span>%{{ ((acc.balance / acc.goalAmount) * 100) | number:'1.0-0' }}</span>
                </div>
                <div class="progress-track">
                  <div class="progress-fill"
                    [style.width.%]="((acc.balance / acc.goalAmount) * 100) > 100 ? 100 : ((acc.balance / acc.goalAmount) * 100)">
                  </div>
                </div>
              </div>
              }
          </div>
          } @empty {
          <div class="empty-state">
            <p>HenÃ¼z aktif bir hesabÄ±nÄ±z bulunmamaktadÄ±r.</p>
            <button class="create-acc-btn">Hesap OluÅŸtur</button>
          </div>
          }
        </div>
        }
      </section>

      <div class="table-container">
        <div class="table-header-title">
          <h3>Son Ä°ÅŸlemler</h3>
        </div>
        <table class="custom-table">
          <thead>
            <tr>
              <th>AÃ§Ä±klama</th>
              <th>Tutar</th>
              <th>Tarih</th>
            </tr>
          </thead>
          <tbody>
            @for (log of transactionLogs(); track log.id) {
            <tr>
              <td>{{ log.description }}</td>
              <td [class.amount-positive]="log.amount > 0" [class.amount-negative]="log.amount < 0">
                {{ log.amount | currency:'TRY':'symbol':'1.2-2' }}
              </td>
              <td>{{ log.transactionDate | date:'dd.MM.yyyy HH:mm' }}</td>
            </tr>
            } @empty {
            <tr>
              <td colspan="3" class="empty-state-row">
                <div class="empty-content">
                  <span class="empty-icon">ğŸ“‚</span>
                  <span>HenÃ¼z iÅŸlem kaydÄ± bulunmamaktadÄ±r.</span>
                </div>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </main>
</div>


@if (showPaymentModal()) {
<div class="modal-overlay" (click)="closePaymentModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Kredi Borcu Ã–deme</h3>
      <button class="close-btn" (click)="closePaymentModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Ã–denecek Hesap</label>
        <input type="text" [value]="selectedLoanAccount?.accountNumber" disabled style="background: #eee;">
      </div>
      <div class="form-group">
        <label>Kaynak Hesap (Vadesiz)</label>
        <select class="form-input" (change)="paymentSourceId = +$any($event.target).value">
          <option value="">SeÃ§iniz</option>
          @for (acc of accounts(); track acc.id) {
          @if (acc.accountType?.toUpperCase() === 'VADESIZ') {
          <option [value]="acc.id">{{ acc.accountNumber }} ({{ acc.balance | currency:'TRY':'symbol':'1.0-0' }})
          </option>
          }
          }
        </select>
      </div>
      <div class="form-group">
        <label>Tutar</label>
        <input type="number" [(ngModel)]="paymentAmount" class="form-input">
      </div>
    </div>
    <div class="modal-footer">
      <button class="save-btn" (click)="submitPayment()">Ã–demeyi Onayla</button>
    </div>
  </div>
</div>
}
